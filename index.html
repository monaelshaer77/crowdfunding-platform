<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crowdfunding Platform - Backer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .hidden { display: none; }
    .campaign-card { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
    .project-image { width: 100%; height: 12rem; object-fit: cover; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1>Crowdfunding Platform - Backer</h1>

    <ul class="nav nav-tabs mb-4">
      <li class="nav-item">
        <a class="nav-link active" href="#" data-section="campaigns">Browse Campaigns</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" data-section="pledges">Pledge History</a>
      </li>
    </ul>

    <div id="campaigns" class="section">
      <h2>Browse Campaigns</h2>
      <div class="mb-3">
        <label for="categoryFilter" class="form-label">Filter by Category</label>
        <select id="categoryFilter" class="form-select">
          <option value="">All</option>
          <option value="Health & Medical">Health & Medical</option>
          <option value="Technology">Technology</option>
          <option value="Education">Education</option>
          <option value="Disability">Disability</option>
          <option value="Sports">Sports</option>
          <option value="Art & Culture">Art & Culture</option>
          <option value="Local Community">Local Community</option>
          <option value="International Aid">International Aid</option>
        </select>
      </div>
      <div id="campaignList" class="row"></div>
    </div>

    <div class="modal fade" id="pledgeModal" tabindex="-1" aria-labelledby="pledgeModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="pledgeModalLabel">Pledge to Campaign</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="pledgeForm">
              <input type="hidden" id="pledgeCampaignId" />
              <input type="hidden" id="pledgeUserId" />
              <div class="mb-3">
                <label for="pledgeAmount" class="form-label">Amount ($)</label>
                <input type="number" class="form-control" id="pledgeAmount" required min="0" />
              </div>
              <div class="mb-3">
                <label for="pledgeReward" class="form-label">Select Reward</label>
                <select id="pledgeReward" class="form-select" required>
                  <option value="">Select a reward</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary" id="pledgeSubmitBtn">Pledge</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div id="pledges" class="section hidden">
      <h2>Pledge History</h2>
      <div id="pledgeList"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = 'http://localhost:3000';

    // لنفترض أن الbacker معرف مسبقًا، عيّنه هنا مباشرة
    const currentUserId = 'backer123'; // غيره حسب ID الbacker الحقيقي
    document.getElementById('pledgeUserId').value = currentUserId;

    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.section');

    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        navLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        sections.forEach(section => section.classList.add('hidden'));
        document.getElementById(link.dataset.section).classList.remove('hidden');

        if (link.dataset.section === 'campaigns') loadCampaigns();
        else if (link.dataset.section === 'pledges') loadPledgeHistory();
      });
    });

    async function loadCampaigns() {
      const campaignList = document.getElementById('campaignList');
      const category = document.getElementById('categoryFilter').value;

      try {
        campaignList.innerHTML = '<div class="text-muted text-center">Loading...</div>';
        const url = category ? `${API_URL}/campaigns?category=${encodeURIComponent(category)}&_sort=deadline` : `${API_URL}/campaigns?_sort=deadline`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to fetch campaigns');
        const campaigns = await res.json();

        campaignList.innerHTML = campaigns.length ? '' : '<div class="text-muted text-center">No campaigns found.</div>';

        campaigns.forEach(c => {
          if (!c.id) return;
          const card = document.createElement('div');
          card.className = 'col-lg-4 col-md-6 mb-4';
          card.innerHTML = `
            <div class="campaign-card">
              <img src="${c.image}" alt="${c.title}" class="project-image" />
              <h4>${c.title}</h4>
              <p>${c.description}</p>
              <p><strong>Category:</strong> ${c.category}</p>
              <p><strong>Goal:</strong> $${c.goal}</p>
              <p><strong>Raised:</strong> $${c.raised || 0}</p>
              <p><strong>Deadline:</strong> ${new Date(c.deadline).toLocaleDateString()}</p>
              <button class="btn btn-primary pledge-btn" data-id="${c.id}" data-bs-toggle="modal" data-bs-target="#pledgeModal">Pledge</button>
            </div>`;
          campaignList.appendChild(card);
        });

        document.querySelectorAll('.pledge-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const campaignId = btn.dataset.id;
            document.getElementById('pledgeCampaignId').value = campaignId;

            const res = await fetch(`${API_URL}/campaigns/${campaignId}`);
            const campaign = await res.json();
            const rewardSelect = document.getElementById('pledgeReward');
            rewardSelect.innerHTML = '<option value="">Select a reward</option>';
            campaign.rewards.forEach((r, index) => {
              const option = document.createElement('option');
              option.value = index;  
              option.text = r.title;
              rewardSelect.appendChild(option);
            });
          });
        });
      } catch (error) {
        campaignList.innerHTML = '<div class="text-danger text-center">Failed to load campaigns</div>';
      }
    }

    document.getElementById('categoryFilter').addEventListener('change', loadCampaigns);

    document.getElementById('pledgeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById('pledgeSubmitBtn');
      submitBtn.disabled = true;

      const amount = parseFloat(document.getElementById('pledgeAmount').value);
      const rewardIndex = document.getElementById('pledgeReward').value;
      const campaignId = document.getElementById('pledgeCampaignId').value;

      try {
        const campaignRes = await fetch(`${API_URL}/campaigns/${campaignId}`);
        if (!campaignRes.ok) throw new Error('Failed to fetch campaign data');
        const campaign = await campaignRes.json();

        // نستخدم رقم index كـ rewardId
        const rewardId = rewardIndex !== "" ? rewardIndex : null;

        const pledge = {
          id: Date.now().toString(),
          campaignId,
          userId: currentUserId,
          amount,
          rewardId,
          createdAt: new Date().toISOString()
        };

        const pledgeResponse = await fetch(`${API_URL}/pledges`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(pledge)
        });

        if (!pledgeResponse.ok) throw new Error('Failed to submit pledge');

        // تحديث قيمة raised في الحملة
        const updatedRaised = (campaign.raised || 0) + amount;
        const updateResponse = await fetch(`${API_URL}/campaigns/${campaignId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ raised: updatedRaised })
        });

        if (!updateResponse.ok) throw new Error('Failed to update campaign raised');

        alert('Pledge submitted successfully!');
        e.target.reset();
        bootstrap.Modal.getInstance(document.getElementById('pledgeModal')).hide();

        loadCampaigns();

      } catch (error) {
        console.error('Error submitting pledge:', error);
        alert('Error submitting pledge: ' + error.message);
      } finally {
        submitBtn.disabled = false;
      }
    });

    async function loadPledgeHistory() {
      const pledgeList = document.getElementById('pledgeList');

      try {
        pledgeList.innerHTML = '<div class="text-muted text-center">Loading...</div>';
        const res = await fetch(`${API_URL}/pledges?userId=${currentUserId}`);
        if (!res.ok) throw new Error('Failed to fetch pledges');
        const pledges = await res.json();

        pledgeList.innerHTML = pledges.length ? '' : '<div class="text-muted text-center">No pledges found.</div>';

        pledges.forEach(p => {
          const div = document.createElement('div');
          div.className = 'mb-3 p-3 border rounded';
          div.innerHTML = `
            <p><strong>Campaign ID:</strong> ${p.campaignId}</p>
            <p><strong>Amount:</strong> $${p.amount}</p>
            <p><strong>Reward Index:</strong> ${p.rewardId !== null ? p.rewardId : 'No reward'}</p>
            <p><small>At: ${new Date(p.createdAt).toLocaleString()}</small></p>
          `;
          pledgeList.appendChild(div);
        });
      } catch (error) {
        pledgeList.innerHTML = '<div class="text-danger text-center">Failed to load pledge history</div>';
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadCampaigns();
    });
  </script>
</body>
</html>
