<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crowdfunding Platform - Backer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .hidden { display: none; }
        .campaign-card { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        .project-image {
  width: 100%;
  height: 12rem; /* 192px */
  object-fit: cover;
}
        
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Crowdfunding Platform - Backer</h1>

        <!-- Navigation -->
        <ul class="nav nav-tabs mb-4">
            <!-- <li class="nav-item">
                <a class="nav-link active" href="#" data-section="register">Register/Login</a>
            </li> -->
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="campaigns">Browse Campaigns</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="pledges">Pledge History</a>
            </li>
        </ul>

        <!-- Register/Login Section -->
        <!-- <div id="register" class="section">
            <h2>Register/Login</h2>
            <form id="userForm">
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary" id="userSubmitBtn">Submit</button>
            </form>
        </div> -->

        <!-- Browse Campaigns Section -->
        <div id="campaigns" class="section hidden">
            <h2>Browse Campaigns</h2>
            <div class="mb-3">
                <label for="categoryFilter" class="form-label">Filter by Category</label>
                <select id="categoryFilter" class="form-select">
                    <option value="">All</option>
                     <option value="Health & Medical">Health & Medical</option>
                    <option value="Technology">Technology</option>
                    <option value="Education">Education</option>
                    <option value="Disability">Disability</option>
                    <option value="Sports">Sports</option>
                    <option value="Art & Culture">Art & Culture</option>
                    <option value="Local Community">Local Community</option>
                    <option value="International Aid">International Aid</option>
                </select>
            </div>
            <div id="campaignList" class="row"></div>
        </div>

        <!-- Pledge Form Modal -->
        <div class="modal fade" id="pledgeModal" tabindex="-1" aria-labelledby="pledgeModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="pledgeModalLabel">Pledge to Campaign</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="pledgeForm">
                            <input type="hidden" id="pledgeCampaignId">
                            <input type="hidden" id="pledgeUserId" value="1"> <!-- Assume logged-in user ID -->
                            <div class="mb-3">
                                <label for="pledgeAmount" class="form-label">Amount ($)</label>
                                <input type="number" class="form-control" id="pledgeAmount" required>
                            </div>
                            <div class="mb-3">
                                <label for="pledgeReward" class="form-label">Select Reward</label>
                                <select id="pledgeReward" class="form-select" required>
                                    <option value="">Select a reward</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary" id="pledgeSubmitBtn">Pledge</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pledge History Section -->
        <div id="pledges" class="section hidden">
            <h2>Pledge History</h2>
            <div id="pledgeList"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000';
        let currentUserId = 1; // Simulate logged-in user (in real app, use auth)

        // Navigation
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                sections.forEach(section => section.classList.add('hidden'));
                document.getElementById(link.dataset.section).classList.remove('hidden');

                if (link.dataset.section === 'campaigns') {
                    loadCampaigns();
                } else if (link.dataset.section === 'pledges') {
                    loadPledgeHistory();
                }
            });
        });

        // Register/Login
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('userSubmitBtn');
            submitBtn.disabled = true;

            const user = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value, // In real app, hash this
                role: 'backer'
            };

            try {
                const response = await fetch(`${API_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                });
                if (!response.ok) throw new Error('Failed to register');
                const newUser = await response.json();
                currentUserId = newUser.id;
                document.getElementById('pledgeUserId').value = currentUserId;
                alert('Registered successfully!');
                document.getElementById('userForm').reset();
            } catch (error) {
                alert('Error registering');
            } finally {
                submitBtn.disabled = false;
            }
        });

        // Load Campaigns
        async function loadCampaigns() {
            const campaignList = document.getElementById('campaignList');
            const category = document.getElementById('categoryFilter').value;

            try {
                campaignList.innerHTML = '<div class="text-muted text-center">Loading...</div>';
                const url = category
                    ? `${API_URL}/campaigns?category=${category}&_sort=deadline`
                    : `${API_URL}/campaigns?_sort=deadline`;
                const res = await fetch(url);
                if (!res.ok) throw new Error('Failed to fetch campaigns');
                const campaigns = await res.json();

                campaignList.innerHTML = campaigns.length
                    ? ''
                    : '<div class="text-muted text-center">No campaigns found.</div>';

                campaigns.forEach(c => {
                    const card = document.createElement('div');
                    card.className = 'col-lg-4 col-md-6 mb-4';
                    card.innerHTML = `
                        <div class="campaign-card">
                            <h4>${c.title}</h4>
                            <p>${c.description}</p>
                            <img src="${c.image}" alt="${c.title}" class="project-image">
                            <p><strong>Category:</strong> ${c.category}</p>
                            <p><strong>Goal:</strong> $${c.goal}</p>
                            <p><strong>Raised:</strong> $${c.raised || 0}</p>
                            <p><strong>Deadline:</strong> ${new Date(c.deadline).toLocaleDateString()}</p>
                            <button class="btn btn-primary pledge-btn" data-id="${c.id}" data-bs-toggle="modal" data-bs-target="#pledgeModal">Pledge</button>
                        </div>
                    `;
                    campaignList.appendChild(card);
                });

                document.querySelectorAll('.pledge-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const campaignId = btn.dataset.id;
                        document.getElementById('pledgeCampaignId').value = campaignId;

                        // Load rewards for the campaign
                        const res = await fetch(`${API_URL}/campaigns/${campaignId}`);
                        const campaign = await res.json();
                        const rewardSelect = document.getElementById('pledgeReward');
                        rewardSelect.innerHTML = '<option value="">Select a reward</option>';
                        campaign.rewards.forEach(r => {
                            const option = document.createElement('option');
                            option.value = r.id;
                            option.text = `${r.title} (Min: $${r.minAmount})`;
                            rewardSelect.appendChild(option);
                        });
                    });
                });
            } catch (error) {
                campaignList.innerHTML = '<div class="text-danger text-center">Failed to load campaigns</div>';
            }
        }

        // Category Filter
        document.getElementById('categoryFilter').addEventListener('change', loadCampaigns);

        // Submit Pledge
        document.getElementById('pledgeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('pledgeSubmitBtn');
            submitBtn.disabled = true;

            const pledge = {
                amount: parseFloat(document.getElementById('pledgeAmount').value),
                rewardId: document.getElementById('pledgeReward').value,
                campaignId: parseInt(document.getElementById('pledgeCampaignId').value),
                userId: parseInt(document.getElementById('pledgeUserId').value),
                createdAt: new Date().toISOString()
            };

            try {
                const response = await fetch(`${API_URL}/pledges`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pledge)
                });
                if (!response.ok) throw new Error('Failed to submit pledge');
                alert('Pledge submitted!');
                document.getElementById('pledgeForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('pledgeModal')).hide();
            } catch (error) {
                alert('Error submitting pledge');
            } finally {
                submitBtn.disabled = false;
            }
        });

        // Load Pledge History
        async function loadPledgeHistory() {
            const pledgeList = document.getElementById('pledgeList');

            try {
                pledgeList.innerHTML = '<div class="text-muted text-center">Loading...</div>';
                const res = await fetch(`${API_URL}/pledges?userId=${currentUserId}`);
                if (!res.ok) throw new Error('Failed to fetch pledges');
                const pledges = await res.json();

                pledgeList.innerHTML = pledges.length
                    ? ''
                    : '<div class="text-muted text-center">No pledges found.</div>';

                pledges.forEach(async p => {
                    // Fetch campaign title for display
                    const campaignRes = await fetch(`${API_URL}/campaigns/${p.campaignId}`);
                    const campaign = await campaignRes.json();

                    const item = document.createElement('div');
                    item.className = 'card mb-2';
                    item.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">Campaign: ${campaign.title}</h5>
                            <p class="card-text">Amount: $${p.amount}</p>
                            <p class="card-text">Reward ID: ${p.rewardId}</p>
                            <p class="card-text">Date: ${new Date(p.createdAt).toLocaleDateString()}</p>
                        </div>
                    `;
                    pledgeList.appendChild(item);
                });
            } catch (error) {
                pledgeList.innerHTML = '<div class="text-danger text-center">Failed to load pledges</div>';
            }
        }
    </script>
</body>
</html>